'use client'

import { useState, useEffect } from 'react'
import { useParams, useRouter } from 'next/navigation'
import Link from 'next/link'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import {
  ArrowLeft,
  Receipt,
  Calendar,
  DollarSign,
  User,
  Package,
  Building2,
  Phone,
  Mail,
  MapPin,
  FileText,
  AlertCircle
} from 'lucide-react'

interface Address {
  id: string
  street?: string
  city?: string
  state?: string
  zipCode?: string
  country?: string
}

interface Contact {
  id: string
  name?: string
  email?: string
  phone?: string
  role?: string
}

interface Account {
  id: string
  name: string
  code?: string
  type?: string
  email?: string
  phone?: string
  addresses?: Address[]
  contacts?: Contact[]
}

interface Product {
  id: string
  name: string
  code?: string
  variety?: string
  grade?: string
}

interface OrderLine {
  id: string
  lineNo: number
  productId: string
  product?: Product
  productCode?: string
  productDescription?: string
  sizeGrade?: string
  quantity: number
  unitSize?: number
  uom?: string
  totalWeight?: number
  unitPrice: number
  total: number
  commissionPct?: number
  commissionAmt?: number
}

interface Order {
  id: string
  orderNo: string
  qboDocNumber?: string
  qboDocId?: string
  orderDate: string
  status: string
  sellerId: string
  seller?: Account
  buyerId: string
  buyer?: Account
  contractNo?: string
  terms?: string
  notes?: string
  subtotal?: string
  commissionTotal?: string
  totalAmount: string
  agentId?: string
  agentName?: string
  lines: OrderLine[]
  createdAt: string
  updatedAt: string
}

export default function OrderDetailPage() {
  const params = useParams()
  const router = useRouter()
  const orderId = params.id as string

  const [order, setOrder] = useState<Order | null>(null)
  const [isLoading, setIsLoading] = useState(true)
  const [error, setError] = useState('')

  useEffect(() => {
    fetchOrder()
  }, [orderId])

  const fetchOrder = async () => {
    setIsLoading(true)
    setError('')
    try {
      const response = await fetch(`http://localhost:2000/api/orders/${orderId}`, {
        credentials: 'include',
      })

      if (!response.ok) {
        if (response.status === 404) {
          throw new Error('Order not found')
        }
        throw new Error('Failed to fetch order')
      }

      const data = await response.json()
      setOrder(data)
    } catch (err: any) {
      console.error('Fetch order error:', err)
      setError(err.message || 'Failed to load order')
    } finally {
      setIsLoading(false)
    }
  }

  const formatCurrency = (amount: string | number) => {
    const num = typeof amount === 'string' ? parseFloat(amount) : amount
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
    }).format(num)
  }

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
    })
  }

  const getStatusColor = (status: string) => {
    switch (status.toLowerCase()) {
      case 'paid':
        return 'bg-green-100 text-green-800'
      case 'posted_to_qb':
        return 'bg-blue-100 text-blue-800'
      case 'confirmed':
        return 'bg-yellow-100 text-yellow-800'
      case 'draft':
        return 'bg-gray-100 text-gray-800'
      default:
        return 'bg-gray-100 text-gray-800'
    }
  }

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center">
          <Package className="mx-auto h-12 w-12 text-gray-400 animate-pulse" />
          <p className="mt-4 text-gray-600">Loading order details...</p>
        </div>
      </div>
    )
  }

  if (error) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center max-w-md">
          <AlertCircle className="mx-auto h-12 w-12 text-red-500" />
          <h2 className="mt-4 text-xl font-semibold text-gray-900">Error Loading Order</h2>
          <p className="mt-2 text-gray-600">{error}</p>
          <div className="mt-6 flex gap-4 justify-center">
            <Button onClick={() => router.back()} variant="outline">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Go Back
            </Button>
            <Button onClick={fetchOrder}>
              Try Again
            </Button>
          </div>
        </div>
      </div>
    )
  }

  if (!order) {
    return null
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Button
            variant="outline"
            size="sm"
            onClick={() => router.back()}
          >
            <ArrowLeft className="h-4 w-4 mr-2" />
            Back
          </Button>
          <div>
            <div className="flex items-center gap-3">
              <Receipt className="h-8 w-8 text-blue-600" />
              <h1 className="text-3xl font-bold text-gray-900">Order Details</h1>
            </div>
            <p className="mt-1 text-gray-600">Order #{order.orderNo}</p>
          </div>
        </div>
        <span
          className={`inline-flex items-center rounded-full px-4 py-2 text-sm font-medium ${getStatusColor(
            order.status
          )}`}
        >
          {order.status.replace(/_/g, ' ').toUpperCase()}
        </span>
      </div>

      {/* Order Info Card */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <FileText className="h-5 w-5" />
            Order Information
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div>
              <label className="text-sm font-medium text-gray-500">Order Number</label>
              <p className="mt-1 text-lg font-semibold text-gray-900 font-mono">{order.orderNo}</p>
            </div>

            {order.qboDocNumber && (
              <div>
                <label className="text-sm font-medium text-gray-500">Invoice Number</label>
                <p className="mt-1 text-lg font-semibold text-blue-600 font-mono">{order.qboDocNumber}</p>
              </div>
            )}

            <div>
              <label className="text-sm font-medium text-gray-500">Order Date</label>
              <div className="mt-1 flex items-center gap-2">
                <Calendar className="h-4 w-4 text-gray-400" />
                <p className="text-gray-900">{formatDate(order.orderDate)}</p>
              </div>
            </div>

            {order.contractNo && (
              <div>
                <label className="text-sm font-medium text-gray-500">Contract Number</label>
                <p className="mt-1 text-gray-900 font-mono">{order.contractNo}</p>
              </div>
            )}

            {order.agentName && (
              <div>
                <label className="text-sm font-medium text-gray-500">Agent</label>
                <div className="mt-1 flex items-center gap-2">
                  <User className="h-4 w-4 text-gray-400" />
                  <p className="text-gray-900">{order.agentName}</p>
                </div>
              </div>
            )}

            {order.terms && (
              <div className="col-span-full">
                <label className="text-sm font-medium text-gray-500">Terms</label>
                <p className="mt-1 text-gray-900">{order.terms}</p>
              </div>
            )}

            {order.notes && (
              <div className="col-span-full">
                <label className="text-sm font-medium text-gray-500">Notes</label>
                <p className="mt-1 text-gray-700 whitespace-pre-wrap">{order.notes}</p>
              </div>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Seller & Buyer Cards */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Seller Card */}
        <Card>
          <CardHeader className="bg-blue-50">
            <CardTitle className="flex items-center gap-2 text-blue-900">
              <Building2 className="h-5 w-5" />
              Seller
            </CardTitle>
          </CardHeader>
          <CardContent className="pt-6">
            {order.seller ? (
              <div className="space-y-4">
                <div>
                  <Link
                    href={`/accounts/${order.seller.id}`}
                    className="text-lg font-semibold text-blue-600 hover:text-blue-800 hover:underline"
                  >
                    {order.seller.name}
                  </Link>
                  {order.seller.code && (
                    <p className="text-sm text-gray-500 font-mono mt-1">Code: {order.seller.code}</p>
                  )}
                  {order.seller.type && (
                    <p className="text-sm text-gray-500 capitalize mt-1">Type: {order.seller.type}</p>
                  )}
                </div>

                {order.seller.email && (
                  <div className="flex items-center gap-2 text-sm text-gray-700">
                    <Mail className="h-4 w-4 text-gray-400" />
                    <a href={`mailto:${order.seller.email}`} className="hover:text-blue-600">
                      {order.seller.email}
                    </a>
                  </div>
                )}

                {order.seller.phone && (
                  <div className="flex items-center gap-2 text-sm text-gray-700">
                    <Phone className="h-4 w-4 text-gray-400" />
                    <a href={`tel:${order.seller.phone}`} className="hover:text-blue-600">
                      {order.seller.phone}
                    </a>
                  </div>
                )}

                {order.seller.addresses && order.seller.addresses.length > 0 && (
                  <div>
                    <label className="text-sm font-medium text-gray-500 flex items-center gap-1">
                      <MapPin className="h-4 w-4" />
                      Address
                    </label>
                    {order.seller.addresses.map((addr) => (
                      <div key={addr.id} className="mt-1 text-sm text-gray-700">
                        {addr.street && <p>{addr.street}</p>}
                        <p>
                          {[addr.city, addr.state, addr.zipCode].filter(Boolean).join(', ')}
                        </p>
                        {addr.country && <p>{addr.country}</p>}
                      </div>
                    ))}
                  </div>
                )}

                {order.seller.contacts && order.seller.contacts.length > 0 && (
                  <div>
                    <label className="text-sm font-medium text-gray-500">Contacts</label>
                    <div className="mt-2 space-y-2">
                      {order.seller.contacts.map((contact) => (
                        <div key={contact.id} className="text-sm bg-gray-50 p-2 rounded">
                          <p className="font-medium text-gray-900">{contact.name}</p>
                          {contact.role && <p className="text-gray-500 text-xs">{contact.role}</p>}
                          {contact.email && (
                            <a href={`mailto:${contact.email}`} className="text-blue-600 hover:underline text-xs">
                              {contact.email}
                            </a>
                          )}
                          {contact.phone && (
                            <p className="text-gray-600 text-xs">{contact.phone}</p>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            ) : (
              <p className="text-gray-500">Seller information not available</p>
            )}
          </CardContent>
        </Card>

        {/* Buyer Card */}
        <Card>
          <CardHeader className="bg-green-50">
            <CardTitle className="flex items-center gap-2 text-green-900">
              <Building2 className="h-5 w-5" />
              Buyer
            </CardTitle>
          </CardHeader>
          <CardContent className="pt-6">
            {order.buyer ? (
              <div className="space-y-4">
                <div>
                  <Link
                    href={`/accounts/${order.buyer.id}`}
                    className="text-lg font-semibold text-green-600 hover:text-green-800 hover:underline"
                  >
                    {order.buyer.name}
                  </Link>
                  {order.buyer.code && (
                    <p className="text-sm text-gray-500 font-mono mt-1">Code: {order.buyer.code}</p>
                  )}
                  {order.buyer.type && (
                    <p className="text-sm text-gray-500 capitalize mt-1">Type: {order.buyer.type}</p>
                  )}
                </div>

                {order.buyer.email && (
                  <div className="flex items-center gap-2 text-sm text-gray-700">
                    <Mail className="h-4 w-4 text-gray-400" />
                    <a href={`mailto:${order.buyer.email}`} className="hover:text-green-600">
                      {order.buyer.email}
                    </a>
                  </div>
                )}

                {order.buyer.phone && (
                  <div className="flex items-center gap-2 text-sm text-gray-700">
                    <Phone className="h-4 w-4 text-gray-400" />
                    <a href={`tel:${order.buyer.phone}`} className="hover:text-green-600">
                      {order.buyer.phone}
                    </a>
                  </div>
                )}

                {order.buyer.addresses && order.buyer.addresses.length > 0 && (
                  <div>
                    <label className="text-sm font-medium text-gray-500 flex items-center gap-1">
                      <MapPin className="h-4 w-4" />
                      Address
                    </label>
                    {order.buyer.addresses.map((addr) => (
                      <div key={addr.id} className="mt-1 text-sm text-gray-700">
                        {addr.street && <p>{addr.street}</p>}
                        <p>
                          {[addr.city, addr.state, addr.zipCode].filter(Boolean).join(', ')}
                        </p>
                        {addr.country && <p>{addr.country}</p>}
                      </div>
                    ))}
                  </div>
                )}

                {order.buyer.contacts && order.buyer.contacts.length > 0 && (
                  <div>
                    <label className="text-sm font-medium text-gray-500">Contacts</label>
                    <div className="mt-2 space-y-2">
                      {order.buyer.contacts.map((contact) => (
                        <div key={contact.id} className="text-sm bg-gray-50 p-2 rounded">
                          <p className="font-medium text-gray-900">{contact.name}</p>
                          {contact.role && <p className="text-gray-500 text-xs">{contact.role}</p>}
                          {contact.email && (
                            <a href={`mailto:${contact.email}`} className="text-green-600 hover:underline text-xs">
                              {contact.email}
                            </a>
                          )}
                          {contact.phone && (
                            <p className="text-gray-600 text-xs">{contact.phone}</p>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            ) : (
              <p className="text-gray-500">Buyer information not available</p>
            )}
          </CardContent>
        </Card>
      </div>

      {/* Line Items Card */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Package className="h-5 w-5" />
            Line Items ({order.lines.length})
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="border border-gray-200 rounded overflow-x-auto max-w-full">
            <table className="w-full text-sm table-fixed">
              <colgroup>
                <col style={{width: '40%'}} />
                <col style={{width: '15%'}} />
                <col style={{width: '10%'}} />
                <col style={{width: '10%'}} />
                <col style={{width: '10%'}} />
                <col style={{width: '15%'}} />
              </colgroup>
              <thead className="bg-gray-50 border-b border-gray-200">
                <tr>
                  <th className="px-2 py-2 text-left text-xs font-medium text-gray-700">Memo</th>
                  <th className="px-2 py-2 text-left text-xs font-medium text-gray-700">Quantity</th>
                  <th className="px-2 py-2 text-left text-xs font-medium text-gray-700">Price/lb</th>
                  <th className="px-2 py-2 text-left text-xs font-medium text-gray-700">Total</th>
                  <th className="px-2 py-2 text-left text-xs font-medium text-gray-700">Comm %</th>
                  <th className="px-2 py-2 text-left text-xs font-medium text-gray-700">Comm Amt</th>
                </tr>
              </thead>
              <tbody className="bg-white">
                {order.lines
                  .sort((a, b) => a.lineNo - b.lineNo)
                  .map((line, index) => {
                    // Calculate quantity display: e.g., "200 cases × 30 lbs = 6,000 lbs"
                    const quantity = parseFloat(String(line.quantity)) || 0
                    const unitSize = parseFloat(String(line.unitSize)) || 0
                    const totalWeight = parseFloat(String(line.totalWeight)) || (quantity * unitSize)
                    const uom = line.uom || 'CASE'
                    const unitPrice = parseFloat(String(line.unitPrice)) || 0
                    const lineTotal = parseFloat(String(line.total)) || 0

                    let quantityDisplay = ''
                    if (uom === 'CASE' && unitSize > 0) {
                      quantityDisplay = `${quantity.toLocaleString()} cases × ${unitSize} lbs = ${totalWeight.toLocaleString()} lbs`
                    } else if (uom === 'BAG' && unitSize > 0) {
                      quantityDisplay = `${quantity.toLocaleString()} bags × ${unitSize} lbs = ${totalWeight.toLocaleString()} lbs`
                    } else {
                      quantityDisplay = `${quantity.toLocaleString()} ${uom.toLowerCase()}`
                    }

                    return (
                      <tr key={line.id} className={index !== order.lines.length - 1 ? 'border-b border-gray-100' : ''}>
                        <td className="px-2 py-2 text-gray-900 text-sm align-top">
                          <div className="break-words whitespace-normal">
                            {line.sizeGrade || line.productDescription || line.productCode || 'N/A'}
                          </div>
                        </td>
                        <td className="px-2 py-2 text-gray-900 text-sm align-top">
                          <div className="break-words whitespace-normal">{quantityDisplay}</div>
                        </td>
                        <td className="px-2 py-2 text-gray-900 text-sm align-top whitespace-nowrap">
                          ${unitPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                        </td>
                        <td className="px-2 py-2 text-gray-900 text-sm align-top whitespace-nowrap">
                          ${lineTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                        </td>
                        <td className="px-2 py-2 text-gray-900 text-sm align-top whitespace-nowrap">
                          {(line.commissionPct || 0) > 0 ? `${line.commissionPct}%` : '—'}
                        </td>
                        <td className="px-2 py-2 text-gray-900 text-sm align-top whitespace-nowrap">
                          ${(parseFloat(String(line.commissionAmt)) || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                        </td>
                      </tr>
                    )
                  })}
                {/* Table Total Row */}
                <tr className="border-t-2 border-gray-300 bg-gray-50">
                  <td colSpan={3} className="px-2 py-2 text-right text-sm font-semibold text-gray-900">
                    Total:
                  </td>
                  <td className="px-2 py-2 pr-6 text-gray-900 whitespace-nowrap font-semibold text-sm">
                    ${order.lines.reduce((sum, line) => {
                      return sum + (parseFloat(String(line.total)) || 0)
                    }, 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                  </td>
                  <td className="px-2 py-2 pl-6 text-right text-sm font-semibold text-gray-900">
                    Total Comm:
                  </td>
                  <td className="px-2 py-2 text-gray-900 whitespace-nowrap font-semibold text-sm">
                    ${order.lines.reduce((sum, line) => {
                      return sum + (parseFloat(String(line.commissionAmt)) || 0)
                    }, 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </CardContent>
      </Card>

      {/* Financial Summary Card */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <DollarSign className="h-5 w-5" />
            Financial Summary
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            {order.subtotal && (
              <div className="flex justify-between items-center py-2">
                <span className="text-gray-600">Subtotal</span>
                <span className="text-lg font-medium text-gray-900">
                  {formatCurrency(order.subtotal)}
                </span>
              </div>
            )}

            {order.commissionTotal && parseFloat(order.commissionTotal) > 0 && (
              <div className="flex justify-between items-center py-2 border-t">
                <span className="text-gray-600">Total Commission</span>
                <span className="text-lg font-medium text-orange-600">
                  {formatCurrency(order.commissionTotal)}
                </span>
              </div>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Metadata */}
      <Card>
        <CardContent className="pt-6">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-500">
            <div>
              <span className="font-medium">Created:</span> {formatDate(order.createdAt)}
            </div>
            <div>
              <span className="font-medium">Last Updated:</span> {formatDate(order.updatedAt)}
            </div>
            {order.qboDocId && (
              <div className="col-span-full">
                <span className="font-medium">QuickBooks Doc ID:</span> <span className="font-mono">{order.qboDocId}</span>
              </div>
            )}
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
